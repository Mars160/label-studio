{% load static %}
{% load i18n %}
{% load filters %}

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="author" content=""/>
  <meta name="viewport" content="width=device-width, initial-scale=0.9, shrink-to-fit=no">

  <!-- Address string color -->
  <meta name="theme-color" content="#272727"> <!-- Chrome, Firefox OS and Opera -->
  <meta name="msapplication-navbutton-color" content="#272727">  <!-- Windows Phone -->
  <meta name="apple-mobile-web-app-status-bar-style" content="#272727">  <!-- iOS Safari -->

  <link href="{{settings.HOSTNAME}}{% static 'css/main.css' %}" rel="stylesheet"/>
  {% block app-css %}
    <link href="{{settings.FRONTEND_HOSTNAME}}/react-app/main.css?v={{ versions.backend.commit }}" rel="stylesheet">
  {% endblock %}


  {% block page_labeling %}
    <title>Label Studio</title>
    <link href="{{settings.HOSTNAME}}{% static 'images/favicon.ico' %}" rel="shortcut icon"/>
  {% endblock %}

  {% block head %}
  {% endblock %}
</head>

<body>
<script nonce="{{request.csp_nonce}}">
  window.APP_SETTINGS = window.APP_SETTINGS ?? {};
  window.APP_SETTINGS.collect_analytics = {{ settings.COLLECT_ANALYTICS|yesno:"true,false" }};

  // Log event to the server, if analytics are enabled
  // This is a fallback for when the __lsa global is not defined
  // Normally this is a part of our main bundle but these pages do not use the main bundle
  // and this allows us to log events from these pages
  const logEvent = (eventName, metadata = {}) => {
    if (!window.APP_SETTINGS?.collect_analytics) return;

    const payload = {
      ...metadata,
      event: eventName,
      url: window.location.href,
    };

    window.requestIdleCallback(() => {
      const params = new URLSearchParams({ __: JSON.stringify(payload) });
      const url = `/__lsa/?${params}`;
      try {
        if (navigator.sendBeacon) {
          navigator.sendBeacon(url);
        } else {
          const img = new Image();
          img.src = url;
        }
      } catch {
        // Ignore errors here
      }
    });
  };
  if (!window.__lsa) {
    window.__lsa = logEvent;
  }

  const frontendEvents = {{ frontend_events|json_dumps_ensure_ascii|safe }};
  frontendEvents.forEach((event) => {
    if (window.APP_SETTINGS.collect_analytics && event.with_iframe) {
      const iframe = document.createElement('iframe');
      iframe.src = `https://www.labelstud.io/track/?event=${event.name}`;
      iframe.style.display = 'none';
      iframe.style.visibility = 'hidden';
      document.body.appendChild(iframe);
    }

    __lsa(event.name);
  });
</script>
{% block content %}
{% endblock %}

</body>
</html>
